{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khire Bladi | {% block title %}{% endblock %}</title>

    <!-- favicon -->
	<link rel="shortcut icon" type="image/png" href="{% static 'img/icon.png' %}">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/all.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}">
	<link rel="stylesheet" href="{% static 'css/magnific-popup.css' %}">
	<link rel="stylesheet" href="{% static 'css/animate.css' %}">
	<link rel="stylesheet" href="{% static 'css/meanmenu.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/responsive.css' %}">
	<link rel="stylesheet" href="{% static 'css/main.css' %}"> 
	<script type="text/javascript">
		var user = '{{request.user}}'

		function getToken(name) {
		    var cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) {
		            var cookie = cookies[i].trim();
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
		var csrftoken = getToken('csrftoken')

		function getCookie(name) {
		    // Split cookie string and get all individual name=value pairs in an array
		    var cookieArr = document.cookie.split(";");

		    // Loop through the array elements
		    for(var i = 0; i < cookieArr.length; i++) {
		        var cookiePair = cookieArr[i].split("=");

		        /* Removing whitespace at the beginning of the cookie name
		        and compare it with the given string */
		        if(name == cookiePair[0].trim()) {
		            // Decode the cookie value and return
		            return decodeURIComponent(cookiePair[1]);
		        }
		    }

		    // Return null if not found
		    return null;
		}
		var cart = JSON.parse(getCookie('cart'))

		if (cart == undefined){
			cart = {}
			console.log('Cart Created!', cart)
			document.cookie ='cart=' + JSON.stringify(cart) + ";domain=;path=/"
		}
		console.log('Cart:', cart)
	
	</script>

    {% block sign_css %} {% endblock sign_css %}
</head>
<body>
{% include 'partials/_navbar.html' %}

{% block content %}
 
{% endblock %}

{% include 'partials/_footer.html' %}

<script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'js/jquery-1.11.3.min.js' %}"></script>
<script src="{% static 'js/jquery.countdown.js' %}"></script>
<script src="{% static 'js/jquery.isotope-3.0.6.min.js' %}"></script>
<script src="{% static 'js/waypoints.js' %}"></script>
<script src="{% static 'js/owl.carousel.min.js' %}"></script>
<script src="{% static 'js/jquery.magnific-popup.min.js' %}"></script>
<script src="{% static 'js/jquery.meanmenu.min.js' %}"></script>
<script src="{% static 'js/sticker.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
<script>
var updateBtns = document.getElementsByClassName('update-cart')

for (i = 0; i < updateBtns.length; i++) {
    updateBtns[i].addEventListener('click', function () {
        var productSlug = this.dataset.product
        var action = this.dataset.action
        console.log('productSlug:', productSlug, 'Action:', action)
        console.log('USER:', user)

        if (user == 'AnonymousUser') {
            addCookieItem(productSlug, action)
        } else {
            updateUserOrder(productSlug, action)
        }
    })
}

function updateUserOrder(productSlug, action) {
    console.log('User is authenticated, sending data...')

    var url = '/products/update_item'

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ 'productSlug': productSlug, 'action': action })
    })
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            // Update the cart information on the page
            updateCartInfo(data.cart_items_count);
        });
}

function addCookieItem(productSlug, action) {
    console.log('User is not authenticated')

    if (action == 'add') {
        if (cart[productSlug] == undefined) {
            cart[productSlug] = { 'quantity': 1 }

        } else {
            cart[productSlug]['quantity'] += 1
        }
    }

    if (action == 'remove') {
        cart[productSlug]['quantity'] -= 1

        if (cart[productSlug]['quantity'] <= 0) {
            console.log('Item should be deleted')
            delete cart[productSlug];
        }
    }
    console.log('CART:', cart)
    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"

    // Update the cart information on the page
    updateCartInfo(calculateTotalItems(cart));
}

// Function to update the cart information on the page
function updateCartInfo(cartItemsCount) {
    // Update the cart count in the navbar
    var cartCountElement = document.querySelector('.cart-count');
	cartCountElement.innerText = cartItemsCount;
    console.log(cartCountElement.length)
    console.log(cartCountElement)
}

// Function to calculate the total number of items in the cart
function calculateTotalItems(cart) {
    var totalItems = 0;
    for (var key in cart) {
        if (cart.hasOwnProperty(key)) {
            totalItems += cart[key]['quantity'];
        }
    }
    return totalItems;
}

</script>
{% block sign_scripts %}{% endblock sign_scripts %}
        
</body>
</html>
